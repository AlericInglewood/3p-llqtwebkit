#!/bin/bash

# make errors fatal
set -e

if [ -z "$AUTOBUILD" ] ; then 
    fail
fi

if [ "$OSTYPE" = "cygwin" ] ; then
    export AUTOBUILD="$(cygpath -u $AUTOBUILD)"
fi

# load autbuild provided shell functions and variables
eval "$("$AUTOBUILD" source_environment)"


# turn on verbose debugging output for logging.
set -x

stage="$(pwd)"
cd "$(dirname "$0")"
top="$(pwd)"
packages="$stage/packages"
install="$stage"

case "$AUTOBUILD_PLATFORM" in
    "windows")
        export PATH=$PATH:"$packages/bin/"

        qmake "CONFIG-=debug" && nmake
        qmake "CONFIG+=debug" && nmake


        mkdir -p "$install/lib/debug"
        mkdir -p "$install/lib/release"
        cp "debug/llqtwebkitd.lib"  "$install/lib/debug"
        cp "release/llqtwebkit.lib" "$install/lib/release"
        mkdir -p "$install/include"
        cp "llqtwebkit.h" "$install/include"
    ;;
    "darwin")
        ln -s "$packages" QTDIR
        xcodebuild -project llqtwebkit.xcodeproj -target llqtwebkit -configuration Release

        mkdir -p "$install/lib/release"
        cp "build/Release/libllqtwebkit.dylib" "$install/lib/release"

        mkdir -p "$install/include"
        cp "llqtwebkit.h" "$install/include"
    ;;
    "linux")
        export MAKEFLAGS="-j12"
        export CXX="g++-4.1" CXXFLAGS="-DQT_NO_INOTIFY -m32 -fno-stack-protector"
        export CC='gcc-4.1' CFLAGS="-m32 -fno-stack-protector"
        export LD="g++-4.1" LDFLAGS="-m32"
        export PATH=$PATH:"$packages/bin/"
        qmake -platform linux-g++-32 CONFIG-=debug
        make -j12

        mkdir -p "$install/lib/release"
        cp "libllqtwebkit.a" "$install/lib/release"

        mkdir -p "$install/include"
        cp "llqtwebkit.h" "$install/include"

        mv "$packages/plugins/imageformats"/libq*.a "$install/lib/release"
    ;;
esac
mkdir -p "$install/LICENSES"
cp "LLQTWEBKIT_LICENSE.txt" "$install/LICENSES/"

pass

